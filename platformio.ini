; =============================================================================
; HOLLOW WATCH - PLATFORMIO CONFIGURATION
; =============================================================================
; Optimized for: T-Watch S3 (ESP32-S3)
; Features: Low power, fast wake, stable BLE, smooth display
; =============================================================================

[env:esp32s3]
platform = espressif32@6.3.0
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
upload_speed = 115200

; Memory configuration for T-Watch S3 (16MB flash, 8MB PSRAM)
board_build.arduino.memory_type = qio_opi
board_build.flash_mode = qio
board_upload.flash_size = 16MB
board_build.partitions = default_16MB.csv

; CPU frequency - Higher for faster wake and better BLE throughput
board_build.f_cpu = 160000000L

; =============================================================================
; BUILD FLAGS - OPTIMIZED FOR PERFORMANCE + POWER EFFICIENCY
; =============================================================================
build_flags =
    ; =========================================================================
    ; USB CONFIGURATION
    ; =========================================================================
    ; POWER: Disable USB CDC on boot in production
    ; Set to 1 for debugging via USB serial
    -DARDUINO_USB_CDC_ON_BOOT=0
    -DARDUINO_USB_MODE=1

    ; =========================================================================
    ; MEMORY CONFIGURATION
    ; =========================================================================
    -DBOARD_HAS_PSRAM
    -DCONFIG_SPIRAM_CACHE_WORKAROUND=1

    ; =========================================================================
    ; DEBUG LEVEL - POWER CRITICAL!
    ; =========================================================================
    ; 0 = none (release), 1 = error, 2 = warn, 3 = info, 4 = debug, 5 = verbose
    ; POWER: Set to 0 for production to disable all logging and save ~2-5mA!
    ; Serial port activity keeps USB/UART peripherals awake
    -DCORE_DEBUG_LEVEL=0
    ; POWER: Disable our custom logging in production (set to 1 to enable for debug)
    -DHOLLOW_DEBUG=0

    ; =========================================================================
    ; BOARD IDENTIFICATION
    ; =========================================================================
    -DARDUINO_ESP32S3_DEV
    -DTWATCH_S3

    ; =========================================================================
    ; LVGL CONFIGURATION (if used)
    ; =========================================================================
    -DLV_CONF_INCLUDE_SIMPLE

    ; =========================================================================
    ; POWER MANAGEMENT - CRITICAL FOR BATTERY LIFE
    ; =========================================================================
    ; Enable ESP-IDF automatic power management
    -DCONFIG_PM_ENABLE=1

    ; Enable FreeRTOS tickless idle for light sleep
    -DCONFIG_FREERTOS_USE_TICKLESS_IDLE=1

    ; Minimum ticks idle before sleep (2 ticks = faster response)
    -DCONFIG_FREERTOS_IDLE_TIME_BEFORE_SLEEP=2

    ; Enable dynamic frequency scaling
    -DCONFIG_PM_DFS_INIT_AUTO=1

    ; Enable light sleep - CRITICAL for battery
    -DCONFIG_PM_POWER_DOWN_CPU_IN_LIGHT_SLEEP=1

    ; =========================================================================
    ; BLE OPTIMIZATION - STABILITY + POWER
    ; =========================================================================
    ; Use IRAM for BLE RX path (faster wake from sleep)
    -DCONFIG_BT_CTRL_BLE_SCAN_DUPL=1

    ; BLE task stack sizes - optimized for stability
    -DCONFIG_BT_BTU_TASK_STACK_SIZE=4096
    -DCONFIG_BLE_MESH_MEM_ALLOC_MODE_INTERNAL=1

    ; Enable BLE power saving
    -DCONFIG_BT_CTRL_LPCLK_SEL_MAIN_XTAL=1

    ; Increase BLE TX buffer for smoother audio streaming
    -DCONFIG_BT_ACL_CONNECTIONS=3

    ; =========================================================================
    ; WIFI - DISABLED FOR POWER SAVINGS
    ; =========================================================================
    ; WiFi is not used in this firmware
    -DCONFIG_ESP_WIFI_SW_COEXIST_ENABLE=0

    ; =========================================================================
    ; BROWNOUT DETECTOR - BATTERY PROTECTION
    ; =========================================================================
    -DCONFIG_ESP_BROWNOUT_DET=1
    -DCONFIG_ESP_BROWNOUT_DET_LVL_SEL_7=1
    

    ; =========================================================================
    ; WATCHDOG - CRASH RECOVERY
    ; =========================================================================
    -DCONFIG_ESP_TASK_WDT=1
    -DCONFIG_ESP_TASK_WDT_TIMEOUT_S=30

    ; =========================================================================
    ; I2S / AUDIO OPTIMIZATION
    ; =========================================================================
    ; Ensure DMA for I2S is enabled
    -DCONFIG_I2S_ISR_IRAM_SAFE=1

    ; =========================================================================
    ; SPI / DISPLAY OPTIMIZATION
    ; =========================================================================
    ; Enable DMA for faster display updates
    -DCONFIG_SPI_MASTER_ISR_IN_IRAM=1

    ; =========================================================================
    ; COMPILER WARNINGS
    ; =========================================================================
    -Wno-unused-variable
    -Wno-unused-function

; =============================================================================
; LIBRARIES - PINNED VERSIONS FOR STABILITY
; =============================================================================
lib_deps =
    lovyan03/LovyanGFX @ ^1.1.9
    lewisxhe/XPowersLib @ ^0.2.4
    adafruit/Adafruit DRV2605 Library @ ^1.2.2

; =============================================================================
; EXTRA SCRIPTS (if needed for custom build steps)
; =============================================================================
; extra_scripts = pre:scripts/pre_build.py

; =============================================================================
; MONITOR FILTERS
; =============================================================================
monitor_filters = default
